<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ì‹¬ì¢…ëª© - ETF ì •ë³´ í”Œë«í¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .watchlist-card {
            transition: transform 0.2s ease-in-out;
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .watchlist-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        .price-up { color: #dc2626; font-weight: bold; }
        .price-down { color: #2563eb; font-weight: bold; }
        .price-neutral { color: #6b7280; font-weight: bold; }
        .user-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stats-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .btn-heart {
            color: #dc3545;
            font-size: 1.2rem;
        }
        .btn-heart.active {
            color: #dc3545;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-chart-line me-2"></i>
                ETF ì •ë³´ í”Œë«í¼
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">ëŒ€ì‹œë³´ë“œ</a>
                <a class="nav-link active" href="/watchlist">ê´€ì‹¬ì¢…ëª©</a>
                <a class="nav-link" href="/rankings">ë­í‚¹</a>
                <a class="nav-link" href="/search">ê²€ìƒ‰</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1><i class="fas fa-heart text-danger me-2"></i>ë‚˜ì˜ ê´€ì‹¬ì¢…ëª©</h1>
                <p class="text-muted">ê´€ì‹¬ ETFë¥¼ ê´€ë¦¬í•˜ê³  ì‹¤ì‹œê°„ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEtfModal">
                    <i class="fas fa-plus me-2"></i>ETF ì¶”ê°€
                </button>
            </div>
        </div>

        <!-- ê´€ì‹¬ì¢…ëª© ëª©ë¡ -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    ê´€ì‹¬ì¢…ëª© ëª©ë¡
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshWatchlist()">
                        <i class="fas fa-sync me-1"></i>ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="loadPopularEtfs()">
                        <i class="fas fa-fire me-1"></i>ì¸ê¸° ETF
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="watchlistContainer" class="row">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ë¡œë”©ì¤‘...</span>
                        </div>
                        <p class="mt-2">ê´€ì‹¬ì¢…ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ETF ì¶”ê°€ ëª¨ë‹¬ -->
    <div class="modal fade" id="addEtfModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ETF ê´€ì‹¬ì¢…ëª© ì¶”ê°€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addEtfForm">
                        <div class="mb-3">
                            <label for="etfCode" class="form-label">ETF ì½”ë“œ (ISIN)</label>
                            <input type="text" class="form-control" id="etfCode" placeholder="ì˜ˆ: KR7069500007" required>
                            <div class="form-text">KODEX 200: KR7069500007</div>
                        </div>
                        <div class="mb-3">
                            <label for="etfMemo" class="form-label">ë©”ëª¨ (ì„ íƒ)</label>
                            <textarea class="form-control" id="etfMemo" rows="3" placeholder="ê°œì¸ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" onclick="addToWatchlist()">ì¶”ê°€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast ì»¨í…Œì´ë„ˆ -->
    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ (ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ì—ì„œ ê°€ì ¸ì˜´)
        let currentUser = null;
        
        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        function checkLoginStatus() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const user = JSON.parse(sessionStorage.getItem('user') || '{}');
            
            if (isLoggedIn !== 'true' || !user.id) {
                showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return false;
            }
            
            currentUser = user;
            return true;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            if (checkLoginStatus()) {
                loadUserInfo();
                loadWatchlist();
                loadStatistics();
            }
        });

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfo() {
            try {
                const response = await fetch(`/api/users/${currentUser.id}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('username').textContent = data.user.username;
                    document.getElementById('email').textContent = data.user.email;
                    document.getElementById('watchlistCount').textContent = data.user.watchListCount || 0;
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê´€ì‹¬ì¢…ëª© ëª©ë¡ ë¡œë“œ
        async function loadWatchlist() {
            try {
                const response = await fetch(`/api/watchlist?userId=${currentUser.id}&includeEtfInfo=true`);
                const data = await response.json();
                
                if (data.success) {
                    displayWatchlist(data.data);
                } else {
                    showToast('ê´€ì‹¬ì¢…ëª© ë¡œë“œ ì‹¤íŒ¨: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('ê´€ì‹¬ì¢…ëª© ë¡œë“œ ì‹¤íŒ¨:', error);
                showToast('ê´€ì‹¬ì¢…ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì „ì²´ í†µê³„ ë¡œë“œ
        async function loadStatistics() {
            try {
                const response = await fetch('/api/watchlist/statistics');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.statistics;
                    document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                    document.getElementById('totalEtfs').textContent = stats.totalEtfs || 0;
                    document.getElementById('totalWatchlists').textContent = stats.totalWatchLists || 0;
                }
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ê°’ í‘œì‹œ
                document.getElementById('totalUsers').textContent = '0';
                document.getElementById('totalEtfs').textContent = '0';
                document.getElementById('totalWatchlists').textContent = '0';
            }
        }

        // ê´€ì‹¬ì¢…ëª© í‘œì‹œ
        function displayWatchlist(watchlistData) {
            const container = document.getElementById('watchlistContainer');
            
            if (!watchlistData || watchlistData.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-heart-broken text-muted" style="font-size: 3rem;"></i>
                        <h5 class="text-muted mt-3">ê´€ì‹¬ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</h5>
                        <p class="text-muted">ETF ì¶”ê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê´€ì‹¬ì¢…ëª©ì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEtfModal">
                            <i class="fas fa-plus me-2"></i>ì²« ë²ˆì§¸ ETF ì¶”ê°€
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            watchlistData.forEach(item => {
                const etf = item.etfInfo;
                const changeClass = etf?.fltRt > 0 ? 'price-up' : (etf?.fltRt < 0 ? 'price-down' : 'price-neutral');
                const changeIcon = etf?.fltRt > 0 ? 'fa-arrow-up' : (etf?.fltRt < 0 ? 'fa-arrow-down' : 'fa-minus');
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card watchlist-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${item.etfName || item.isinCd}</h6>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromWatchlist('${item.isinCd}')">
                                        <i class="fas fa-heart-broken"></i>
                                    </button>
                                </div>
                                <p class="text-muted small mb-2">${item.shortCode} (${item.isinCd})</p>
                                
                                ${etf ? `
                                <div class="row text-center mb-2">
                                    <div class="col-6">
                                        <strong>${etf.closePrice?.toLocaleString() || '-'}</strong>
                                        <div class="small text-muted">ì¢…ê°€</div>
                                    </div>
                                    <div class="col-6">
                                        <strong class="${changeClass}">
                                            <i class="fas ${changeIcon}"></i>
                                            ${etf.fltRt?.toFixed(2) || '0.00'}%
                                        </strong>
                                        <div class="small text-muted">ë“±ë½ë¥ </div>
                                    </div>
                                </div>
                                ` : '<div class="text-center text-muted">ETF ì •ë³´ ì—†ìŒ</div>'}
                                
                                ${item.memo ? `
                                <div class="border-top pt-2 mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-sticky-note me-1"></i>
                                        ${item.memo}
                                    </small>
                                </div>
                                ` : ''}
                                
                                <div class="text-end mt-2">
                                    <small class="text-muted">${new Date(item.createdAt).toLocaleDateString()}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ê´€ì‹¬ì¢…ëª© ì¶”ê°€
        async function addToWatchlist() {
            const etfCode = document.getElementById('etfCode').value.trim();
            const memo = document.getElementById('etfMemo').value.trim();
            
            if (!etfCode) {
                showToast('ETF ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `userId=${currentUser.id}&isinCd=${etfCode}&memo=${encodeURIComponent(memo)}`
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('ê´€ì‹¬ì¢…ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    document.getElementById('addEtfForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addEtfModal')).hide();
                    loadWatchlist();
                    loadUserInfo();
                } else {
                    showToast('ì¶”ê°€ ì‹¤íŒ¨: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('ê´€ì‹¬ì¢…ëª© ì¶”ê°€ ì‹¤íŒ¨:', error);
                showToast('ê´€ì‹¬ì¢…ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê´€ì‹¬ì¢…ëª© ì œê±°
        async function removeFromWatchlist(isinCd) {
            if (!confirm('ì •ë§ë¡œ ê´€ì‹¬ì¢…ëª©ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/watchlist/${isinCd}?userId=${currentUser.id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('ê´€ì‹¬ì¢…ëª©ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    loadWatchlist();
                    loadUserInfo();
                } else {
                    showToast('ì œê±° ì‹¤íŒ¨: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('ê´€ì‹¬ì¢…ëª© ì œê±° ì‹¤íŒ¨:', error);
                showToast('ê´€ì‹¬ì¢…ëª© ì œê±° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê´€ì‹¬ì¢…ëª© ìƒˆë¡œê³ ì¹¨
        function refreshWatchlist() {
            loadWatchlist();
            loadUserInfo();
            loadStatistics();
            showToast('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ!', 'success');
        }

        // ì¸ê¸° ETF ë¡œë“œ
        async function loadPopularEtfs() {
            try {
                const response = await fetch('/api/watchlist/popular?limit=5');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    let message = 'ğŸ“ˆ ì¸ê¸° ETF TOP 5:\n';
                    data.forEach((etf, index) => {
                        message += `${index + 1}. ${etf.etfName} (â¤ï¸${etf.likeCount})\n`;
                    });
                    alert(message);
                } else {
                    showToast('ì¸ê¸° ETF ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                }
            } catch (error) {
                console.error('ì¸ê¸° ETF ë¡œë“œ ì‹¤íŒ¨:', error);
                showToast('ì¸ê¸° ETFë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // Toast ë©”ì‹œì§€ í‘œì‹œ
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // í† ìŠ¤íŠ¸ê°€ ìˆ¨ê²¨ì§„ í›„ DOMì—ì„œ ì œê±°
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
    </script>
</body>
</html>
