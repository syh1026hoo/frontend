<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF ì •ë³´ í”Œë«í¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .price-up { color: #dc2626; font-weight: bold; }
        .price-down { color: #2563eb; font-weight: bold; }
        .price-neutral { color: #6b7280; font-weight: bold; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-chart-line me-2"></i>
                ETF ì •ë³´ í”Œë«í¼
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/test">í…ŒìŠ¤íŠ¸</a>
                <a class="nav-link" href="/test-setup">í…ŒìŠ¤íŠ¸ ì„¤ì •</a>
                <a class="nav-link" href="/api/test/etf/sync" target="_blank">API í…ŒìŠ¤íŠ¸</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="row mb-4">
            <div class="col-12">
                <h1>ğŸ›ï¸ ETF ì‹œì¥ ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-muted">ì‹¤ì‹œê°„ ETF ì‹œì¥ í˜„í™©ê³¼ ì£¼ìš” ì§€í‘œë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            </div>
        </div>

        <!-- ì‹œì¥ í˜„í™© í†µê³„ -->
        <div class="row mb-4" th:if="${marketStats}">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-list fa-2x text-primary mb-2"></i>
                        <h4 th:text="${marketStats.totalCount}">0</h4>
                        <p class="text-muted mb-0">ì „ì²´ ETF</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-arrow-up fa-2x text-danger mb-2"></i>
                        <h4 class="price-up" th:text="${marketStats.risingCount}">0</h4>
                        <p class="text-muted mb-0">ìƒìŠ¹</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-arrow-down fa-2x text-primary mb-2"></i>
                        <h4 class="card-title price-down" th:text="${marketStats.fallingCount}">0</h4>
                        <p class="text-muted mb-0">í•˜ë½</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-minus fa-2x text-secondary mb-2"></i>
                        <h4 class="price-neutral" th:text="${marketStats.stableCount}">0</h4>
                        <p class="text-muted mb-0">ë³´í•©</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë“±ë½ë¥  êµ¬ê°„ë³„ ë¶„í¬ ì°¨íŠ¸ -->
        <div class="row mb-4" th:if="${marketStats}">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            ë“±ë½ë¥  êµ¬ê°„ë³„ ë¶„í¬
                        </h5>
                        <small class="text-muted">ì „ì²´ ì¢…ëª©ìˆ˜: <span th:text="${marketStats.totalCount}">0</span>ê°œ</small>
                    </div>
                    <div class="card-body">
                        <canvas id="changeRateDistributionChart" style="max-height: 400px;"></canvas>
                        <div id="noDataMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                            <p>ë“±ë½ë¥  êµ¬ê°„ë³„ ë¶„í¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            <small>ETF ë°ì´í„° ë™ê¸°í™”ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                            <div class="mt-3">
                                <a href="/api/test/etf/sync" class="btn btn-primary btn-sm" target="_blank">
                                    <i class="fas fa-sync me-1"></i>
                                    ë°ì´í„° ë™ê¸°í™” ì‹¤í–‰
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë“±ë½ë¥  ìƒìœ„ ETF -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-arrow-up text-danger me-2"></i>
                            ë“±ë½ë¥  ìƒìœ„ Top 5
                        </h5>
                        <a href="/api/test/etf/top-gainers" class="btn btn-sm btn-outline-primary" target="_blank">API ë³´ê¸°</a>
                    </div>
                    <div class="card-body p-0">
                        <div th:if="${topGainers != null and !topGainers.empty}">
                            <div th:each="etf, iterStat : ${topGainers}" 
                                 class="d-flex justify-content-between align-items-center p-3 border-bottom">
                                <div>
                                    <h6 class="mb-1" th:text="${etf.itmsNm}">ETFëª…</h6>
                                    <small class="text-muted" th:text="${etf.srtnCd}">ì½”ë“œ</small>
                                </div>
                                <div class="text-end">
                                    <div class="price-up" th:text="'+' + ${etf.fltRt} + '%'">+5.23%</div>
                                    <small class="text-muted" 
                                           th:text="${#numbers.formatDecimal(etf.closePrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'">30,000ì›</small>
                                </div>
                            </div>
                        </div>
                        <div th:if="${topGainers == null or topGainers.empty}" class="p-3 text-center text-muted">
                            ë°ì´í„° ë™ê¸°í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤
                        </div>
                    </div>
                </div>
            </div>

            <!-- ê±°ë˜ëŸ‰ ìƒìœ„ ETF -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar text-success me-2"></i>
                            ê±°ë˜ëŸ‰ ìƒìœ„ Top 5
                        </h5>
                        <a href="/api/test/etf/most-traded-volume" class="btn btn-sm btn-outline-primary" target="_blank">API ë³´ê¸°</a>
                    </div>
                    <div class="card-body p-0">
                        <div th:if="${mostTradedVolume != null and !mostTradedVolume.empty}">
                            <div th:each="etf, iterStat : ${mostTradedVolume}" 
                                 class="d-flex justify-content-between align-items-center p-3 border-bottom">
                                <div>
                                    <h6 class="mb-1" th:text="${etf.itmsNm}">ETFëª…</h6>
                                    <small class="text-muted" th:text="${etf.srtnCd}">ì½”ë“œ</small>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold" th:text="${#numbers.formatDecimal(etf.tradeVolume, 0, 'COMMA', 0, 'POINT')}">1,000,000</div>
                                    <small class="text-muted">ì£¼</small>
                                </div>
                            </div>
                        </div>
                        <div th:if="${mostTradedVolume == null or mostTradedVolume.empty}" class="p-3 text-center text-muted">
                            ë°ì´í„° ë™ê¸°í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-bolt me-2"></i>
                            ë¹ ë¥¸ ì•¡ì…˜
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="/watchlist" class="btn btn-outline-danger w-100">
                                    <i class="fas fa-heart me-2"></i>
                                    ë‚˜ì˜ ê´€ì‹¬ì¢…ëª©
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="/api/test/etf/sync" class="btn btn-outline-primary w-100" target="_blank">
                                    <i class="fas fa-sync me-2"></i>
                                    ë°ì´í„° ë™ê¸°í™”
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="/api/test/etf/search?keyword=ë°˜ë„ì²´" class="btn btn-outline-info w-100" target="_blank">
                                    <i class="fas fa-microchip me-2"></i>
                                    ë°˜ë„ì²´ ETF
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="/api/test/etf/search?keyword=KODEX" class="btn btn-outline-success w-100" target="_blank">
                                    <i class="fas fa-chart-line me-2"></i>
                                    KODEX ETF
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="/api/test/etf/market-stats" class="btn btn-outline-warning w-100" target="_blank">
                                    <i class="fas fa-chart-pie me-2"></i>
                                    ì‹œì¥ í†µê³„
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>ì‚¬ìš© ì•ˆë‚´</h6>
                    <ul class="mb-0">
                        <li>ë¨¼ì € <strong>"ë°ì´í„° ë™ê¸°í™”"</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìµœì‹  ETF ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”</li>
                        <li>API ë§í¬ë¥¼ í´ë¦­í•˜ë©´ JSON í˜•íƒœì˜ ì›ì‹œ ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                        <li>ëª¨ë“  ë°ì´í„°ëŠ” ê³µê³µë°ì´í„°í¬í„¸ ì¦ê¶Œìƒí’ˆì‹œì„¸ì •ë³´ APIì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script th:if="${marketStats}" th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // Chart.js ë¡œë”© í™•ì¸
            if (typeof Chart === 'undefined') {
                console.error('Chart.jsê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                return;
            }
            console.log('Chart.js ë¡œë”© í™•ì¸:', typeof Chart);
            
            // ë””ë²„ê¹…: ë°ì´í„° í™•ì¸
            console.log('=== ë°ì´í„° ë””ë²„ê¹… ì‹œì‘ ===');
            console.log('marketStats:', /*[[${marketStats}]]*/);
            
            // canvas ìš”ì†Œ í™•ì¸
            const canvas = document.getElementById('changeRateDistributionChart');
            if (!canvas) {
                console.error('canvas ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            console.log('canvas ìš”ì†Œ í™•ì¸:', canvas);
            
            // ë“±ë½ë¥  êµ¬ê°„ë³„ ë¶„í¬ ì°¨íŠ¸
            const distributionCtx = canvas.getContext('2d');
            if (!distributionCtx) {
                console.error('canvas contextë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // ë””ë²„ê¹…: marketStats ê°ì²´ í™•ì¸
            console.log('marketStats:', /*[[${marketStats}]]*/ null);
            console.log('changeRateDistribution:', /*[[${marketStats.changeRateDistribution}]]*/ null);
            
            // ë“±ë½ë¥  êµ¬ê°„ë³„ ë°ì´í„°
            const changeRateData = {
                labels: ['-10% ì´í•˜', '-10% ~ -5%', '-5% ~ -3%', '-3% ~ -1%', '-1% ~ 0%', '0%', '0% ~ 1%', '1% ~ 3%', '3% ~ 5%', '5% ~ 10%', '10% ì´ìƒ'],
                datasets: [{
                    label: 'ì¢…ëª© ìˆ˜',
                    data: [
                        /*[[${marketStats?.changeRateDistribution?.get('-10') ?: 0}]]*/ 0,
                        /*[[${marketStats?.changeRateDistribution?.get('-5') ?: 0}]]*/ 9,
                        /*[[${marketStats?.changeRateDistribution?.get('-3') ?: 0}]]*/ 51,
                        /*[[${marketStats?.changeRateDistribution?.get('-1') ?: 0}]]*/ 438,
                        /*[[${marketStats?.changeRateDistribution?.get('0') ?: 0}]]*/ 737,
                        /*[[${marketStats?.stableCount ?: 0}]]*/ 105,
                        /*[[${marketStats?.changeRateDistribution?.get('1') ?: 0}]]*/ 620,
                        /*[[${marketStats?.changeRateDistribution?.get('3') ?: 0}]]*/ 127,
                        /*[[${marketStats?.changeRateDistribution?.get('5') ?: 0}]]*/ 17,
                        /*[[${marketStats?.changeRateDistribution?.get('10') ?: 0}]]*/ 1,
                        /*[[${marketStats?.changeRateDistribution?.get('10+') ?: 0}]]*/ 0
                    ],
                    backgroundColor: [
                        '#1e40af', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd',
                        '#6b7280', '#fca5a5', '#f87171', '#ef4444', '#dc2626', '#991b1b'
                    ],
                    borderColor: [
                        '#1e40af', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd',
                        '#6b7280', '#fca5a5', '#f87171', '#ef4444', '#dc2626', '#991b1b'
                    ],
                    borderWidth: 1
                }]
            };

            // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
            const totalData = changeRateData.datasets[0].data.reduce((sum, value) => sum + value, 0);
            console.log('ì´ ë°ì´í„° í•©ê³„:', totalData);
            
            // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ì²˜ë¦¬
            if (totalData === 0) {
                console.log('ë“±ë½ë¥  êµ¬ê°„ë³„ ë¶„í¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¹ˆ ì°¨íŠ¸ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.');
                
                // ë©”ì‹œì§€ í‘œì‹œ
                const noDataMessage = document.getElementById('noDataMessage');
                if (noDataMessage) {
                    noDataMessage.style.display = 'block';
                }
                
                // Canvas ìˆ¨ê¸°ê¸°
                canvas.style.display = 'none';
                return;
            } else {
                // ë°ì´í„°ê°€ ìˆì„ ë•Œ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                const noDataMessage = document.getElementById('noDataMessage');
                if (noDataMessage) {
                    noDataMessage.style.display = 'none';
                }
                canvas.style.display = 'block';
            }

            // ë°ì´í„° ë””ë²„ê¹…
            console.log('changeRateData:', changeRateData);
            console.log('changeRateData.data:', changeRateData.datasets[0].data);
            
            try {
                // ì°¨íŠ¸ ìƒì„±
                const chart = new Chart(distributionCtx, {
                    type: 'bar',
                    data: changeRateData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'ì¢…ëª© ìˆ˜'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'ë“±ë½ë¥  êµ¬ê°„'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed.y + 'ê°œ';
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('ì°¨íŠ¸ ìƒì„± ì„±ê³µ:', chart);
                
            } catch (error) {
                console.error('ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
            
            console.log('=== ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ ===');
        });
    </script>
</body>
</html>
